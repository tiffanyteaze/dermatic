{% extends "layout.html" %}
{% from 'macros.html' import render_field %}

{% block content %}
<div class="product" id={{ product }}>
    <h1 class="product-header"></h1>
</div>

<div class="row">
    <h5>Ingredient Summary:</h5>
</div>

<div class="row">
    <div class="ingredients"></div>
</div>  

<div class="row">
        <div class="hidden-ingredient-wrapper"></div>
    </div>  

<div class="row">
    <button class="fav-btn" id={{ product }}>Add To Favorites</button>
</div>

<div class="row">
    <form method="POST" action="">
        {{ form.hidden_tag() }}
        {% for field in form %}
            {{ render_field(field) }}
        {% endfor %}
        <button type="submit" id="submit">Post a review!</button>
    </form>
</div>


{% for review in reviews %}
<div class="row review-container">
    <p>"{{ review.content }}" by {{ review.user.username }}</p>
    {% if review.user.id ==  currentuser %}
        <form action="{{ url_for('delete_review', productid=review.product_id, userid=review.user.id) }}" method=post class=delete-review>
            <input type=hidden value="{{review.product_id}}"name=productid</input>
            <input type=hidden value="{{review.user}}"name=userid</input>
            <input type=submit value="Delete" class="btn btn-warning btn-block"></input>
        </form>
        <a class="btn btn-info edit-review-btn" href="{{ url_for('edit_review', productid=review.product_id, userid=currentuser) }}">Edit</a>
    {% endif %}
</div>
{% endfor %}

<script>
    let productId = $('.product')[0].attributes.id.value
    let productArray = []
    let mostSimilarIngredients = 0;
    let mostSimilarIngredientsId;
    let mostSimilarIngredientsName;
    let similarIngredientsTwo = 0;

    $(document).ready(function(e){
        $.ajax({
            method: 'GET',
            url: `https://stormy-castle-78446.herokuapp.com/products/${productId}`,
            success: function (response) {
                $('.product-header').html(`${response.brand} ${response.name}`)
                for (let i = 0; i < 5; i++) {
                    let card = $(`<div class="card ingredient-wrapper"/>`);
                    let ingredientText = $(`<p class="${i}"></p>`);
                    $(ingredientText).html(response.ingredient_list[i])
                    card.append(ingredientText)
                    $('.ingredients').append(card)
                }

                for (let j = 0; j < response.ingredient_list.length; j++){
                    productArray.push(response.ingredient_list[j])
                }
            },
            error: function(error) {
            console.log(error);
            }
        });

        $.ajax({
            method: 'GET',
            url: `https://stormy-castle-78446.herokuapp.com/products`,
            success: function(response) {
                let allProducts = response;
                for (n = 0; n < 1000; n+=2){
                    let firstArray = allProducts[n].ingredient_list;
                    let firstArrayId = allProducts[n].id;
                    let firstArrayName = `${allProducts[n].brand} ${allProducts[n].name}`

                    let secondArray = allProducts[n+1].ingredient_list;
                    let secondArrayId = allProducts[n+1].id;
                    let secondArrayName = `${allProducts[n+1].brand} ${allProducts[n+1].name}`

                    let similarIngredientsOne = 0;
                    if (firstArrayId != productId){
                        for (i = 0; i < productArray.length; i++) {
                            for(j = 0; j < firstArray.length; j++){
                                if (productArray[i] === firstArray[j]){
                                    similarIngredientsOne++;
                                }
                            }
                        }
                    }
                    console.log(firstArrayName)
                    console.log(similarIngredientsOne)

                    let similarIngredientsTwo = 0;
                    if (secondArrayId != productId){
                        for (i = 0; i < productArray.length; i++) {
                            for(j = 0; j < secondArray.length; j++){
                                if (productArray[i] === secondArray[j]){
                                    similarIngredientsOne++;
                                }
                            }
                        }
                    }
                    console.log(secondArrayName)
                    console.log(similarIngredientsTwo)

                    if (similarIngredientsOne > similarIngredientsTwo && similarIngredientsOne > mostSimilarIngredients){
                        mostSimilarIngredients = similarIngredientsOne;
                        mostSimilarIngredientsId = firstArrayId;
                        mostSimilarIngredientsName = firstArrayName;
                    }

                    else if (similarIngredientsTwo > similarIngredientsOne && similarIngredientsTwo > mostSimilarIngredients){
                        mostSimilarIngredients = similarIngredientsTwo;
                        mostSimilarIngredientsId = secondArrayId;
                        mostSimilarIngredientsName = secondArrayName;
                    }

                    else if (similarIngredientsOne === similarIngredientsTwo){
                        mostSimilarIngredients = similarIngredientsOne;
                        mostSimilarIngredientsId = firstArrayId;
                        mostSimilarIngredientsName = firstArrayName;
                    }
                    console.log(`Most Similar Ingredients:`)
                    console.log(mostSimilarIngredientsName)
                }
            }
        })
    });

    $('.fav-btn').click(function(e){
        $.ajax({
            method: 'POST',
            url: `http://localhost:8000/product/${e.target.id}`,
            success: function(res) {
                console.log(`Product was added to favorites: ${res}`)
            },
            error: function(error) {
                console.log(error)
            }
        })
    })


</script>
{% endblock %}
